<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="settings.title">Einstellungen ‚Äì Verein[t]</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#0b0b0b" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="/assets/pwa/icon-192.png" />

  <!-- Styles -->
  <link rel="stylesheet" href="/style.css" />
  <style>
    main { padding: 16px 16px 84px; }
    .card { background: #111; border-radius: 12px; padding: 16px; margin-bottom: 1rem; border: 1px solid #2a2a2a; }
    .card h2 { margin-top: 0; font-size: 1.2rem; }
    .row { margin-top: 8px; }
    select, input[type=text], input[type=email] {
      width: 100%; padding: 10px; border: 1px solid #333; border-radius: 8px;
      background: #0f0f0f; color: #eaeaea;
    }
    .btn {
      display:inline-block; padding:10px 12px; border-radius:8px;
      border:0; cursor:pointer; background:var(--accent,#2ea44f); color:#0b0b0b; font-weight:600;
    }
    .btn.danger { background:#b32d2d; color:#fff; }
    .muted { color:#9aa0a6; font-size:.9rem; }
  </style>

  <!-- i18n -->
  <script defer src="/assets/js/languages.js"></script>
  <script defer src="/assets/js/i18n.js"></script>
  <script defer src="/assets/js/lang-toggle.js"></script>

  <!-- Nav -->
  <script defer src="/assets/js/nav.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>

<body>
  <main>
    <h1 data-i18n="settings.heading">Einstellungen</h1>

    <section class="card" id="userCard">
      <h2 data-i18n="settings.user">Benutzer</h2>
      <p><span class="muted" data-i18n="settings.loggedInAs">Angemeldet als:</span> <span id="userEmail">-</span></p>
      <p><span class="muted">Rolle:</span> <span id="userRole">-</span></p>
      <button id="logoutBtn" class="btn danger" data-i18n="settings.logout">Abmelden</button>
    </section>

    <section class="card">
      <h2 data-i18n="settings.language">Sprache</h2>
      <label for="langSelect" class="muted" data-i18n="settings.selectLang">Bevorzugte Sprache:</label>
      <select id="langSelect">
        <option value="de">Deutsch</option>
        <option value="en">English</option>
        <option value="fr">Fran√ßais</option>
        <option value="tr">T√ºrk√ße</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="fa">ŸÅÿßÿ±ÿ≥€å</option>
        <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
      </select>
      <div class="row">
        <button id="saveLangBtn" class="btn" data-i18n="settings.saveLang">Sprache speichern</button>
      </div>
    </section>

    <section class="card" id="adminCard" style="display:none;">
      <h2>üõ° Admin</h2>
      <p data-i18n="settings.adminNote">Zugang zur Administration</p>
      <a href="/administration/" class="btn">Zur Admin-Seite</a>
    </section>
  </main>

  <script>
    const SUPABASE_URL  = "https://ntccnkvpxrpwgxmiherf.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Y2Nua3ZweHJwd2d4bWloZXJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MzgyODYsImV4cCI6MjA2ODQxNDI4Nn0.JncC2HbFHONVid0aRYXfFohMu5D_ORVwj0XgyQg3khc";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const userEmail = document.getElementById('userEmail');
    const userRole = document.getElementById('userRole');
    const adminCard = document.getElementById('adminCard');
    const langSelect = document.getElementById('langSelect');

    async function loadUser() {
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;
      if (!user) {
        location.href = "/auth/login.html";
        return;
      }
      userEmail.textContent = user.email;
      const { data: prof } = await supabaseClient.from('user_profiles').select('rolle, language').eq('id', user.id).maybeSingle();
      const role = prof?.rolle || "user";
      userRole.textContent = role;
      if (prof?.language) langSelect.value = prof.language;
      if (role === "admin") adminCard.style.display = "";
    }

    document.getElementById('logoutBtn').onclick = async () => {
      await supabaseClient.auth.signOut();
      location.href = "/";
    };

    document.getElementById('saveLangBtn').onclick = async () => {
      const lang = langSelect.value;
      if (window.i18n) i18n.setLanguage(lang);
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;
      if (user) {
        await supabaseClient.from('user_profiles').update({ language: lang }).eq('id', user.id);
      }
      alert("Sprache gespeichert: " + lang);
    };

    loadUser();
  </script>
</body>
</html>
