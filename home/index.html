<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verein[t] â€“ Schule. Basketball. FÃ¼r Alle.</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0b">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/assets/pwa/icon-192.png">

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () =>
        navigator.serviceWorker.register('/sw.js').catch(() => {})
      );
    }
  </script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- STYLES -->
  <style>
    :root{
      --bg:#0b0b0b; --fg:#eaeaea; --accent:#2ea44f; --border:#1f1f1f;
      --muted:#9aa0a6; font-family:system-ui,-apple-system,Roboto,Arial,sans-serif;
    }
    body{margin:0;background:var(--bg);color:var(--fg);}
    main{padding:16px 16px 84px;}
    h1{text-align:center;margin-top:2rem;font-size:1.6rem;}
    p{text-align:center;color:var(--muted);margin-top:0;}
    .grid-2{display:grid;gap:1rem;grid-template-columns:1fr;}
    @media(min-width:840px){.grid-2{grid-template-columns:1fr 1fr;}}
    .card{background:#111;border:1px solid var(--border);border-radius:12px;padding:16px;}
    .card:hover{border-color:var(--accent);}
    .auth-card input{width:100%;padding:10px;border-radius:8px;border:1px solid #2a2a2a;background:#141414;color:#eaeaea;margin-top:8px;}
    .row.inline{display:flex;gap:8px;flex-wrap:wrap;}
    .row.inline>*{flex:1 1 200px;}
    .auth-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
    .btn{padding:10px 12px;border-radius:8px;text-decoration:none;color:#fff;border:1px solid #2a2a2a;background:#1a1a1a;cursor:pointer;}
    .btn.primary{background:var(--accent);color:#0b0b0b;font-weight:700;border-color:transparent;}
    .muted-small{color:var(--muted);font-size:.9rem;margin-top:6px;}
    .err{color:#ff7b7b;font-size:.9rem;margin-top:8px;}
    .ok{color:#6ee7a1;font-size:.9rem;margin-top:8px;}
    .user-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .user-email{font-weight:600;}
  </style>
</head>

<body>
  <main>
    <section class="hero">
      <h1>Willkommen bei Verein[t]</h1>
      <p>Schule. Basketball. FÃ¼r Alle.</p>
    </section>

    <!-- LOGIN + REGISTRIERUNG -->
    <section class="grid-2" style="margin-top:16px">
      <!-- LOGIN -->
      <div class="card auth-card" id="authLogin">
        <h2>ğŸ” Anmeldung</h2>
        <label class="muted-small">E-Mail</label>
        <input id="loginEmail" type="email" placeholder="name@example.org">
        <label class="muted-small">Passwort</label>
        <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <div class="auth-actions">
          <button id="loginBtn" class="btn primary">Einloggen</button>
          <button id="resetBtn" class="btn">Passwort zurÃ¼cksetzen</button>
        </div>
        <div id="loginMsg" class="err" style="display:none"></div>
        <div id="loginOk" class="ok" style="display:none">Erfolgreich angemeldet.</div>
      </div>

      <!-- REGISTRIERUNG -->
      <div class="card auth-card" id="authSignup">
        <h2>ğŸ“ Registrierung</h2>
        <div class="row inline">
          <div>
            <label class="muted-small">Vorname</label>
            <input id="regFirst">
          </div>
          <div>
            <label class="muted-small">Nachname</label>
            <input id="regLast">
          </div>
        </div>
        <div class="row inline">
          <div>
            <label class="muted-small">Schule</label>
            <input id="regSchool" placeholder="z. B. GS Eversten">
          </div>
          <div>
            <label class="muted-small">Geburtsjahr</label>
            <input id="regBirth" type="number" min="2008" max="2035">
          </div>
        </div>
        <label class="muted-small">E-Mail</label>
        <input id="regEmail" type="email">
        <label class="muted-small">Passwort</label>
        <input id="regPw" type="password">
        <label class="muted-small" style="display:flex;align-items:center;gap:6px;margin-top:8px;">
          <input id="regConsent" type="checkbox"> Datenschutz akzeptiert
        </label>
        <div class="auth-actions">
          <button id="signupBtn" class="btn primary">Registrieren</button>
          <button id="clearSignup" class="btn">Felder leeren</button>
        </div>
        <div id="signupMsg" class="err" style="display:none"></div>
        <div id="signupOk" class="ok" style="display:none">BestÃ¤tigungs-E-Mail gesendet.</div>
      </div>
    </section>

    <!-- USER-INFO -->
    <section id="userSection" class="card" style="margin-top:16px;display:none;">
      <div class="user-row">
        <div>
          <div class="muted-small">Angemeldet als</div>
          <div id="userEmail" class="user-email"></div>
        </div>
        <div class="auth-actions" style="margin-top:0">
          <a href="/messenger/" class="btn">Zum Messenger</a>
          <button id="logoutBtn" class="btn">Abmelden</button>
        </div>
      </div>
    </section>

    <!-- INFO-KARTEN -->
    <section class="grid-2" style="margin-top:16px">
      <div class="card">
        <h2>ğŸ—“ NÃ¤chste Termine</h2>
        <p>Ãœbersicht der kommenden Events aus dem Kalender-Modul.</p>
      </div>
      <div class="card">
        <h2>ğŸ’¬ Letzte Nachrichten</h2>
        <p>Neue Chat-Nachrichten aus deinen Teams.</p>
      </div>
      <div class="card">
        <h2>ğŸŒ Netzwerk</h2>
        <p>Partner, Schulen & FÃ¶rderer auf einen Blick.</p>
      </div>
    </section>
  </main>

  <!-- LOGIN/REGISTRIERUNG-LOGIK -->
  <script>
    const SUPABASE_URL = "https://ntccnkvpxrpwgxmiherf.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Y2Nua3ZweHJwd2d4bWloZXJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MzgyODYsImV4cCI6MjA2ODQxNDI4Nn0.JncC2HbFHONVid0aRYXfFohMu5D_ORVwj0XgyQg3khc";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const els = {
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      loginMsg: document.getElementById('loginMsg'),
      loginOk: document.getElementById('loginOk'),
      signupMsg: document.getElementById('signupMsg'),
      signupOk: document.getElementById('signupOk'),
      regFirst: document.getElementById('regFirst'),
      regLast: document.getElementById('regLast'),
      regSchool: document.getElementById('regSchool'),
      regBirth: document.getElementById('regBirth'),
      regEmail: document.getElementById('regEmail'),
      regPw: document.getElementById('regPw'),
      regConsent: document.getElementById('regConsent'),
      userEmail: document.getElementById('userEmail'),
      userSection: document.getElementById('userSection'),
      authLogin: document.getElementById('authLogin'),
      authSignup: document.getElementById('authSignup')
    };

    function show(el, visible){ el.style.display = visible ? '' : 'none'; }

    async function refreshAuthUI(){
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;
      show(els.authLogin, !user);
      show(els.authSignup, !user);
      show(els.userSection, !!user);
      if (user) els.userEmail.textContent = user.email;
    }

    // LOGIN
    document.getElementById('loginBtn').onclick = async ()=>{
      const { error } = await supabaseClient.auth.signInWithPassword({
        email: els.loginEmail.value,
        password: els.loginPassword.value
      });
      if (error){ els.loginMsg.textContent = error.message; show(els.loginMsg,true);}
      else{ show(els.loginOk,true); refreshAuthUI(); }
    };

    // RESET
    document.getElementById('resetBtn').onclick = async ()=>{
      const { error } = await supabaseClient.auth.resetPasswordForEmail(
        els.loginEmail.value,{ redirectTo: location.origin + '/auth/reset.html' }
      );
      els.loginMsg.textContent = error ? error.message : 'Reset-Link wurde gesendet.';
      show(els.loginMsg,true);
    };

    // SIGNUP
    document.getElementById('signupBtn').onclick = async ()=>{
      if(!els.regConsent.checked){
        els.signupMsg.textContent = 'Bitte Datenschutz bestÃ¤tigen.'; show(els.signupMsg,true); return;
      }

      const { data, error } = await supabaseClient.auth.signUp({
        email: els.regEmail.value,
        password: els.regPw.value,
        options:{
          data:{
            vorname: els.regFirst.value,
            nachname: els.regLast.value,
            schule: els.regSchool.value,
            geburtsjahr: els.regBirth.value,
            rolle:'user'
          },
          emailRedirectTo: location.origin + '/auth/callback.html'
        }
      });

      if(error){ els.signupMsg.textContent = error.message; show(els.signupMsg,true); return; }

      if(data?.user){
        await supabaseClient.from('user_profiles').insert([{
          id:data.user.id,
          vorname: els.regFirst.value,
          nachname: els.regLast.value,
          schule: els.regSchool.value,
          geburtsjahr: els.regBirth.value,
          email: els.regEmail.value,
          rolle:'user',
          datenschutz: els.regConsent.checked,
          created_at:new Date().toISOString()
        }]);
      }

      els.signupMsg.textContent = 'BestÃ¤tigungs-E-Mail gesendet.';
      show(els.signupMsg,true); show(els.signupOk,true);
    };

    // CLEAR
    document.getElementById('clearSignup').onclick = ()=>{
      [els.regFirst,els.regLast,els.regSchool,els.regBirth,els.regEmail,els.regPw].forEach(i=>i.value='');
      els.regConsent.checked=false; show(els.signupMsg,false); show(els.signupOk,false);
    };

    // LOGOUT
    document.getElementById('logoutBtn').onclick = async ()=>{
      await supabaseClient.auth.signOut(); refreshAuthUI();
    };

    supabaseClient.auth.onAuthStateChange(()=>refreshAuthUI());
    refreshAuthUI();
  </script>
</body>
</html>
