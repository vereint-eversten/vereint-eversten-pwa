<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title data-i18n="home.metaTitle">Verein[t] ‚Äì Schule. Basketball. F√ºr Alle.</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0b">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/assets/pwa/icon-192.png">
  <meta name="app-build" content="2025-10-17">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () =>
        navigator.serviceWorker.register('/sw.js').catch(() => {})
      );
    }
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="/style.css">

  <!-- i18n (dynamisch, keine festen JSON-Dateien) -->
  <script defer src="/assets/js/languages.js"></script>
  <script defer src="/assets/js/i18n.js"></script>
  <script defer src="/assets/js/lang-toggle.js"></script>

  <!-- Navigation -->
  <script defer src="/assets/js/nav.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    main { padding: 16px 16px 84px; }
    .hero { text-align: center; margin-top: 2rem; }
    .hero h1 { font-size: 1.6rem; margin-bottom: .5rem; }
    .hero p { color: #9aa0a6; margin: 0; }

    .grid-2 { display: grid; gap: 1rem; grid-template-columns: 1fr; }
    @media (min-width: 840px) { .grid-2 { grid-template-columns: 1fr 1fr; } }

    .card:hover { border-color: var(--accent); }

    .auth-card input, .auth-card select {
      width: 100%; padding: 10px; border-radius: 8px;
      border: 1px solid #2a2a2a; background: #141414; color: #eaeaea; margin-top: 8px;
    }
    .row { margin-top: 8px; }
    .row.inline { display: flex; gap: 8px; flex-wrap: wrap; }
    .row.inline > * { flex: 1 1 200px; }

    .auth-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .btn { display: inline-block; padding: 10px 12px; border-radius: 8px;
      text-decoration: none; color: #fff; border: 1px solid #2a2a2a; background: #1a1a1a; }
    .btn.primary { background: var(--accent,#2ea44f); border-color: transparent; color: #0b0b0b; font-weight: 700; }

    .muted-small { color: #9aa0a6; font-size: .9rem; margin-top: 6px; }
    .err { color: #ff7b7b; font-size: .9rem; margin-top: 8px; }
    .ok { color: #6ee7a1; font-size: .9rem; margin-top: 8px; }
    .user-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .user-email { font-weight: 600; }
  </style>
</head>

<body data-auth="out">
  <main>
    <section class="hero">
      <h1 data-i18n="home.title">Willkommen bei Verein[t]</h1>
      <p data-i18n="home.subtitle">Schule. Basketball. F√ºr Alle.</p>
    </section>

    <!-- LOGIN / REGISTRIERUNG -->
    <section class="grid-2" style="margin-top:16px">
      <!-- LOGIN -->
      <div class="card auth-card" id="authLogin">
        <h2>üîê Anmeldung</h2>
        <label class="muted-small">E-Mail</label>
        <input id="loginEmail" type="email" placeholder="name@example.org">
        <label class="muted-small">Passwort</label>
        <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="auth-actions">
          <button id="loginBtn" class="btn primary">Einloggen</button>
          <button id="resetBtn" class="btn">Passwort zur√ºcksetzen</button>
        </div>
        <div id="loginMsg" class="err" style="display:none"></div>
        <div id="loginOk" class="ok" style="display:none">Erfolgreich angemeldet.</div>
      </div>

      <!-- REGISTRIERUNG -->
      <div class="card auth-card" id="authSignup">
        <h2>üìù Registrierung</h2>
        <div class="row inline">
          <div>
            <label class="muted-small">Vorname</label>
            <input id="regFirst">
          </div>
          <div>
            <label class="muted-small">Nachname</label>
            <input id="regLast">
          </div>
        </div>
        <div class="row inline">
          <div>
            <label class="muted-small">Schule</label>
            <input id="regSchool" placeholder="z. B. GS Eversten">
          </div>
          <div>
            <label class="muted-small">Geburtsjahr</label>
            <input id="regBirth" type="number" min="2008" max="2035">
          </div>
        </div>
        <label class="muted-small">E-Mail</label>
        <input id="regEmail" type="email">
        <label class="muted-small">Passwort</label>
        <input id="regPw" type="password">
        <label class="muted-small">
          <input id="regConsent" type="checkbox">
          Ich stimme der Datenschutzerkl√§rung zu
          <a href="/datenschutz.html" target="_blank" class="btn">Details</a>
        </label>
        <div class="auth-actions">
          <button id="signupBtn" class="btn primary">Registrieren</button>
          <button id="clearSignup" class="btn">Felder leeren</button>
        </div>
        <div id="signupMsg" class="err" style="display:none"></div>
        <div id="signupOk" class="ok" style="display:none">Best√§tigungs-E-Mail wurde gesendet.</div>
      </div>
    </section>

    <!-- USER-INFO -->
    <section id="userSection" class="card" style="margin-top:16px; display:none;">
      <div class="user-row">
        <div>
          <div class="muted-small">Angemeldet als</div>
          <div id="userEmail" class="user-email"></div>
        </div>
        <div class="auth-actions" style="margin-top:0">
          <a href="/messenger/" class="btn">Zum Messenger</a>
          <button id="logoutBtn" class="btn">Abmelden</button>
        </div>
      </div>
    </section>

    <!-- INHALTE -->
    <section class="grid-2" style="margin-top:16px">
      <div class="card">
        <h2>üóì N√§chste Termine</h2>
        <p>√úbersicht der kommenden Events aus dem Kalender-Modul.</p>
      </div>
      <div class="card">
        <h2>üí¨ Letzte Nachrichten</h2>
        <p>Neue Chat-Nachrichten aus deinen Teams.</p>
      </div>
      <div class="card">
        <h2>üåê Netzwerk</h2>
        <p>Partner, Schulen & F√∂rderer auf einen Blick.</p>
      </div>
    </section>
  </main>

  <!-- LOGIN/REGISTRIERUNG MIT SUPABASE -->
  <script>
    const SUPABASE_URL  = "https://ntccnkvpxrpwgxmiherf.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50Y2Nua3ZweHJwd2d4bWloZXJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MzgyODYsImV4cCI6MjA2ODQxNDI4Nn0.JncC2HbFHONVid0aRYXfFohMu5D_ORVwj0XgyQg3khc";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const authLogin = document.getElementById('authLogin');
    const authSignup = document.getElementById('authSignup');
    const userSection = document.getElementById('userSection');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginMsg = document.getElementById('loginMsg');
    const loginOk = document.getElementById('loginOk');
    const regFirst = document.getElementById('regFirst');
    const regLast = document.getElementById('regLast');
    const regSchool = document.getElementById('regSchool');
    const regBirth = document.getElementById('regBirth');
    const regEmail = document.getElementById('regEmail');
    const regPw = document.getElementById('regPw');
    const regConsent = document.getElementById('regConsent');
    const signupMsg = document.getElementById('signupMsg');
    const signupOk = document.getElementById('signupOk');
    const userEmail = document.getElementById('userEmail');

    function show(el, visible) { el.style.display = visible ? '' : 'none'; }

    async function refreshAuthUI() {
      const { data } = await supabaseClient.auth.getSession();
      const user = data?.session?.user;
      show(authLogin, !user);
      show(authSignup, !user);
      show(userSection, !!user);
      if (user) userEmail.textContent = user.email;
    }

    document.getElementById('loginBtn').onclick = async () => {
      const { error } = await supabaseClient.auth.signInWithPassword({
        email: loginEmail.value,
        password: loginPassword.value
      });
      if (error) { loginMsg.textContent = error.message; show(loginMsg, true); }
      else { show(loginOk, true); refreshAuthUI(); }
    };

    document.getElementById('resetBtn').onclick = async () => {
      const { error } = await supabaseClient.auth.resetPasswordForEmail(loginEmail.value, {
        redirectTo: location.origin + '/auth/reset.html'
      });
      loginMsg.textContent = error ? error.message : 'Reset-Link wurde gesendet.';
      show(loginMsg, true);
    };

    document.getElementById('signupBtn').onclick = async () => {
      if (!regConsent.checked) {
        signupMsg.textContent = 'Bitte Datenschutz best√§tigen.'; show(signupMsg, true); return;
      }

      const { data, error } = await supabaseClient.auth.signUp({
        email: regEmail.value,
        password: regPw.value,
        options: {
          data: {
            vorname: regFirst.value,
            nachname: regLast.value,
            schule: regSchool.value,
            geburtsjahr: regBirth.value,
            rolle: "user"
          },
          emailRedirectTo: location.origin + '/auth/callback.html'
        }
      });

      if (error) { signupMsg.textContent = error.message; show(signupMsg, true); return; }

      // zus√§tzlichen Datensatz in user_profiles anlegen
      if (data?.user) {
        await supabaseClient.from('user_profiles').insert([{
          id: data.user.id,
          vorname: regFirst.value,
          nachname: regLast.value,
          schule: regSchool.value,
          geburtsjahr: regBirth.value,
          email: regEmail.value,
          rolle: 'user',
          datenschutz: regConsent.checked,
          created_at: new Date().toISOString()
        }]);
      }

      signupMsg.textContent = 'Best√§tigungs-E-Mail wurde gesendet.';
      show(signupMsg, true); show(signupOk, true);
    };

    document.getElementById('clearSignup').onclick = () => {
      [regFirst, regLast, regSchool, regBirth, regEmail, regPw].forEach(i => i.value = '');
      regConsent.checked = false; show(signupMsg, false); show(signupOk, false);
    };

    document.getElementById('logoutBtn').onclick = async () => {
      await supabaseClient.auth.signOut();
      refreshAuthUI();
    };

    supabaseClient.auth.onAuthStateChange(() => refreshAuthUI());
    refreshAuthUI();
  </script>
</body>
</html>
